<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Custom One-Stage Group-by functions • disk.frame</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Custom One-Stage Group-by functions">
<meta property="og:description" content="disk.frame">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">disk.frame</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.5.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-intro.html">Preface - The birth of `disk.frame`</a>
    </li>
    <li>
      <a href="../articles/02-intro-disk-frame.html">Quick Start: Basic Operations with nycflights13</a>
    </li>
    <li>
      <a href="../articles/03-concepts.html">Key `{disk.frame}` concepts</a>
    </li>
    <li>
      <a href="../articles/04-ingesting-data.html">Ingesting Data</a>
    </li>
    <li>
      <a href="../articles/05-data-table-syntax.html">Using data.table syntax with disk.frame</a>
    </li>
    <li>
      <a href="../articles/06-vs-dask-juliadb.html">Benchmarks 1: disk.frame beats Dask! disk.frame beats JuliaDB! Anyone else wanna challenge?</a>
    </li>
    <li>
      <a href="../articles/07-glm.html">Generalized Linear Models (GLM) including logistic regression with disk.frame</a>
    </li>
    <li>
      <a href="../articles/08-more-epic.html">{disk.frame} can be more 'epic'</a>
    </li>
    <li>
      <a href="../articles/09-convenience-features.html">Convenience features</a>
    </li>
    <li>
      <a href="../articles/10-group-by.html">Group-by</a>
    </li>
    <li>
      <a href="../articles/11-custom-group-by.html">Custom One-Stage Group-by functions</a>
    </li>
    <li>
      <a href="../articles/88-trouble-shooting.html">Trouble shooting</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/xiaodaigh/disk.frame/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Custom One-Stage Group-by functions</h1>
                        <h4 data-toc-skip class="author">ZJ</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/xiaodaigh/disk.frame/blob/HEAD/vignettes/11-custom-group-by.Rmd" class="external-link"><code>vignettes/11-custom-group-by.Rmd</code></a></small>
      <div class="hidden name"><code>11-custom-group-by.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="custom-one-stage-group-by">Custom one-stage group-by<a class="anchor" aria-label="anchor" href="#custom-one-stage-group-by"></a>
</h2>
<p>Group-by is one the most useful and commonly used operations in data manipulation. The most common to perform group with dplyr syntax would be something similar to the below</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">grpA</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>However, the above nice and concise group-by syntax creates a challenge in <a href="https://diskframe.com" class="external-link">disk.frame</a>, because <a href="https://diskframe.com" class="external-link">disk.frame</a> organises the data in chunks and these chunks are often manipulated independently to each other which makes it difficult to compute the <code>mean</code> of any column if the group-by column is stored in different chunks. In this chapter, I will explain how <a href="https://diskframe.com" class="external-link">disk.frame</a> achieve the one-stage group-by syntax that you see, and how you can define custom one-stage group-by functions for use with <a href="https://diskframe.com" class="external-link">disk.frame</a>.</p>
<div class="section level3">
<h3 id="at-a-glance">At a glance<a class="anchor" aria-label="anchor" href="#at-a-glance"></a>
</h3>
<p><a href="https://diskframe.com" class="external-link">disk.frame</a> allows the user to create custom one-stage group-by functions. To make a function <code>fn</code> one stage, one needs to define two functions:</p>
<ol style="list-style-type: decimal">
<li>
<code>fn_df.chunk_agg.disk.frame</code> which applies itself to each chunk</li>
<li>
<code>fn_df.collected_agg.disk.frame</code> which accepts a <code>list</code> of returns from <code>fn_df.chunk_agg.disk.frame</code> and finalize the computation</li>
</ol>
<p>For example, to make <code>mean</code> a one-stage group-by function, <a href="https://diskframe.com" class="external-link">disk.frame</a> has defined <code>mean_df.chunk_agg.disk.frame</code> and <code>mean_df.collected_agg.disk.frame</code>, which we will illustrate with examples below.</p>
<p>But first, we shall explain some theory behind <a href="https://diskframe.com" class="external-link">disk.frame</a> to help you better understand “why does <a href="https://diskframe.com" class="external-link">disk.frame</a> do it like that?”.</p>
</div>
<div class="section level3">
<h3 id="how-does-disk-frame-work">How does <code>{disk.frame}</code> work<a class="anchor" aria-label="anchor" href="#how-does-disk-frame-work"></a>
</h3>
<p>One may ask, how come only a few functions are supported for one-stage group-by? And why are some functions like <code>median</code> only produce estimates instead of producing the exact figure? To answer these questions, we need to have an understanding of how <a href="https://diskframe.com" class="external-link">disk.frame</a> works.</p>
<p>A <code>disk.frame</code> is organized as chunks stored on disk. Each chunk is a file stored in <a href="https://www.fstpackage.org/" class="external-link">fst format</a>. The <a href="https://CRAN.R-project.org/package=future" class="external-link"><code>{future}</code> package</a> is used to apply the same function to each chunk, each of these operations are carried out in a separate R session. These R sessions cannot communicate with each other during the execution of the operations.</p>
<p>Once the operations have been performed on all chunks, the results will be bought back to the session from which the operations were called. This is the only point of inter-process communication.</p>
<p>To summarize, the two phases of a <code>df %&gt;% some_fn %&gt;% collect</code> operation are</p>
<ol style="list-style-type: decimal">
<li>The <code>some_fn</code> is applied to each chunk, and the result is assumed to be a data.frame</li>
<li>
<code>collect</code> then row-binds (<code>rbind</code>/<code>bind_rows</code>/<code>rbindlist</code>) the results together to form a data.frame in the main session</li>
</ol>
</div>
<div class="section level3">
<h3 id="how-group-by-works">How group-by works<a class="anchor" aria-label="anchor" href="#how-group-by-works"></a>
</h3>
<p>Except for passing the result back to the main session, communication between worker sessions are not allowed. This limits how group-by operations can be performed, hence why group-by was done in two stages prior to <a href="https://diskframe.com" class="external-link">disk.frame</a> v0.3.0. However, R’s meta-programming abilities allow us to rewrite code to perform the two-stage group-bys using one-stage group-by code. For example, consider:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">grp1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="va">collect</span></code></pre></div>
<p>we can use meta-programming to transform that to</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chunk_group_by</span>(grp1) <span class="sc">%&gt;%</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chunk_summarize</span>(<span class="at">__tmp1__=</span> <span class="fu">sum</span>(x)) <span class="sc">%&gt;%</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(grp1) <span class="sc">%&gt;%</span> </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">x =</span> <span class="fu">sum</span>(__tmp1__))</span></code></pre></div>
<p>Basically, we are “compiling” one-stage group-by code to two-stage group-by code, and then executing it.</p>
<p>For <code>mean</code>, it’s trickier, as one needs to keep track on the numerator and the denominator separately in computing <code>mean(x) = sum(x)/length(x)</code>.</p>
<p>Therefore, <a href="https://diskframe.com" class="external-link">disk.frame</a> compiles</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">grp1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>meanx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="va">collect</span></code></pre></div>
<p>to</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chunk_group_by</span>(grp1) <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chunk_summarize</span>(<span class="at">__tmp1__ =</span> <span class="fu">list</span>(<span class="fu">mean_df.chunk_agg.disk.frame</span>(x))) <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  collect <span class="sc">%&gt;%</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(grp1) <span class="sc">%&gt;%</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chunk_summarize</span>(<span class="at">meanx =</span> <span class="fu">mean_df.chunk_agg.disk.frame</span>(__tmp1__))</span></code></pre></div>
<p>where <code>mean_df.chunk_agg.disk.frame</code> defines what needs to be done to each chunk, as you can see, the return value is a vector where the elements are named <code>sumx</code> and <code>lengthx</code>. Also note because the return value is not a scalar, we need to write it in a <code>list</code> (line 3).</p>
<p>Here is an example implementation of <code>mean.chunk_agg.disk.frame</code></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mean_df.chunk_agg.disk.frame</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">sumx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="va">na.rm</span><span class="op">)</span>
  <span class="va">lengthx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">na.rm</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>sumx <span class="op">=</span> <span class="va">sumx</span>, lengthx <span class="op">=</span> <span class="va">lengthx</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The <code>mean_df.collected_agg.disk.frame</code> receives a list of outputs from <code>mean_df.chunk_agg.disk.frame</code>. Recall that <code>mean.chunk_agg.disk.frame</code> returns a vector for each chunk, so the input to <code>mean_df.collected_agg.disk.frame</code> is a <em>list of vectors</em></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mean_df.collected_agg.disk.frame</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">listx</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">listx</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="st">"sumx"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">listx</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="st">"lengthx"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="how-to-define-custom-one-stage-group-by-functions">How to define custom one-stage group-by functions<a class="anchor" aria-label="anchor" href="#how-to-define-custom-one-stage-group-by-functions"></a>
</h3>
<p>Now that we have seen two examples, namely <code>sum</code> and <code>mean</code>, we are ready to summarize how group-by functions are implemented.</p>
<p>Given the below</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">grp1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>namex <span class="op">=</span> <span class="fu">fn</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="va">collect</span></code></pre></div>
<p><a href="https://diskframe.com" class="external-link">disk.frame</a> compiles it to</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chunk_group_by</span>(grp1) <span class="sc">%&gt;%</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chunk_summarize</span>(<span class="at">__tmp1__ =</span> <span class="fu">list</span>(<span class="fu">fn_df.chunk_agg.disk.frame</span>(x))) <span class="sc">%&gt;%</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  collect <span class="sc">%&gt;%</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(grp1) <span class="sc">%&gt;%</span> </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chunk_summarize</span>(<span class="at">namex =</span> <span class="fu">fn_df.collected_agg.disk.frame</span>(__tmp1__))</span></code></pre></div>
<p>Based on the above information, to make <code>fn</code> a one-stage group-by function, the user has to</p>
<ol style="list-style-type: decimal">
<li>Define <code>fn_df.chunk_agg.disk.frame</code> which is a function to be applied to each chunk</li>
<li>Define <code>fn_df.collected_agg.disk.frame</code> which is a function to be applied to <em>a <code>list</code> containing the returns from <code>fn.chunk_agg.disk.frame</code> applied to each chunk</em>
</li>
</ol>
<p><strong>Example of implementing <code>sum</code></strong>:</p>
<ol style="list-style-type: decimal">
<li>Define <code>sum_df.chunk_agg.disk.frame</code>
</li>
</ol>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sum_df.chunk_agg.disk.frame</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span>, na.rm<span class="op">=</span><span class="va">na.rm</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Define <code>sum_df.collected_agg.disk.frame</code>, which needs to accept a list of <code>sum(x, na.rm)</code>, but <code>sum(x, na.rm)</code> is just a numeric, so</li>
</ol>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sum_df.collected_agg.disk.frame</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">list_sum</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">list_sum</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p><strong>Example of implementing <code>n_distinct</code></strong>:</p>
<p>The <code><a href="https://dplyr.tidyverse.org/reference/n_distinct.html" class="external-link">dplyr::n_distinct</a></code> function counts the number of distint values from a vector <code>x</code></p>
<ol style="list-style-type: decimal">
<li>Define <code>n_distinct_df.chunk_agg.disk.frame</code>, to return a list of unique values. Because the same value can appear in multiple chunks, to ensure that we don’t double count, we simply return all the unique values from each chunk which is then de-duplicated in the next phase</li>
</ol>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_distinct_df.chunk_agg.disk.frame</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span><span class="op">(</span><span class="va">na.rm</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Define <code>n_distinct_df.collected_agg.disk.frame</code>, which de-duplicates the unique values</li>
</ol>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_distinct_df.collected_agg.disk.frame</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">list_of_chunkwise_uniques</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html" class="external-link">n_distinct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">list_of_chunkwise_uniques</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="limitations">Limitations<a class="anchor" aria-label="anchor" href="#limitations"></a>
</h3>
<p>We have seen that <a href="https://diskframe.com" class="external-link">disk.frame</a> performs operations in two phases</p>
<ol style="list-style-type: decimal">
<li>apply the same function to each chunk</li>
<li>row-bind the results</li>
</ol>
<p>and there are no communication between the sessions that applies the functions at chunk level.</p>
<p>Hence, it is generally difficult to compute rank based summarizations like <code>median</code> exactly. Hence most rank based calculations are estimates only. This is also true of distributed data system like Spark whose median function is also estimates only.</p>
<p>Another limitation for now is that summarization that is more complex then <code>f(x)</code> is not supported. E.g. <code>sum(x) + 1</code>, <code>sum(x + mean(x))</code>, <code>sum(x) + mean(x)</code>, and <code>fn(sum(x))</code> are not yet supported as arguments in the <code>summarize</code> function.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Dai ZJ.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
