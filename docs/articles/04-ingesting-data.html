<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ingesting Data • disk.frame</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Ingesting Data">
<meta property="og:description" content="disk.frame">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">disk.frame</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-intro.html">Preface - The birth of `disk.frame`</a>
    </li>
    <li>
      <a href="../articles/02-intro-disk-frame.html">Quick Start: Basic Operations with nycflights13</a>
    </li>
    <li>
      <a href="../articles/03-concepts.html">Key `{disk.frame}` concepts</a>
    </li>
    <li>
      <a href="../articles/04-ingesting-data.html">Ingesting Data</a>
    </li>
    <li>
      <a href="../articles/05-data-table-syntax.html">Using data.table syntax with disk.frame</a>
    </li>
    <li>
      <a href="../articles/06-vs-dask-juliadb.html">Benchmarks 1: disk.frame beats Dask! disk.frame beats JuliaDB! Anyone else wanna challenge?</a>
    </li>
    <li>
      <a href="../articles/07-glm.html">Generalized Linear Models (GLM) including logistic regression with disk.frame</a>
    </li>
    <li>
      <a href="../articles/08-more-epic.html">{disk.frame} can be more 'epic'</a>
    </li>
    <li>
      <a href="../articles/09-convenience-features.html">Convenience features</a>
    </li>
    <li>
      <a href="../articles/10-group-by.html">Group-by</a>
    </li>
    <li>
      <a href="../articles/11-custom-group-by.html">Custom One-Stage Group-by functions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/xiaodaigh/disk.frame/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Ingesting Data</h1>
                        <h4 class="author">ZJ</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/xiaodaigh/disk.frame/blob/master/vignettes/04-ingesting-data.Rmd"><code>vignettes/04-ingesting-data.Rmd</code></a></small>
      <div class="hidden name"><code>04-ingesting-data.Rmd</code></div>

    </div>

    
    
<div id="ingesting-data" class="section level1">
<h1 class="hasAnchor">
<a href="#ingesting-data" class="anchor"></a>Ingesting Data</h1>
<p>One of the most important tasks to perform before using the <code>{disk.frame}</code> package is to make some <code>disk.frame</code>s! There are a few functions to help you do that. Before we do that, we set up the <code>{disk.frame}</code> as usual</p>
<p><strong>Setting up</strong></p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">disk.frame</span>)

<span class="co"># set-up disk.frame to use multiple workers</span>
<span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/interactive.html">interactive</a></span>()) {
  <span class="fu"><a href="../reference/setup_disk.frame.html">setup_disk.frame</a></span>()
  <span class="co"># highly recommended, however it is pun into interactive() for CRAN because</span>
  <span class="co"># change user options are not allowed on CRAN</span>
  <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="kw">future.globals.maxSize</span> <span class="kw">=</span> <span class="fl">Inf</span>)
} <span class="kw">else</span> {
  <span class="fu"><a href="../reference/setup_disk.frame.html">setup_disk.frame</a></span>(<span class="fl">2</span>)
}</pre></body></html></div>
<div id="convert-a-data-frame-to-disk-frame" class="section level2">
<h2 class="hasAnchor">
<a href="#convert-a-data-frame-to-disk-frame" class="anchor"></a>Convert a <code>data.frame</code> to <code>disk.frame</code>
</h2>
<p>Firstly, there is <code><a href="../reference/as.disk.frame.html">as.disk.frame()</a></code> which allows you to make a <code>disk.frame</code> from a <code>data.frame</code>, e.g.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">flights.df</span> <span class="kw">=</span> <span class="fu"><a href="../reference/as.disk.frame.html">as.disk.frame</a></span>(<span class="kw pkg">nycflights13</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/nycflights13/man/flights.html">flights</a></span>)</pre></body></html></div>
<p>will convert the <code><a href="https://rdrr.io/pkg/nycflights13/man/flights.html">nycflights13::flights</a></code> <code>data.frame</code> to a <code>disk.frame</code> somewhere in <code><a href="https://rdrr.io/r/base/tempfile.html">tempdir()</a></code>. To find out the location of the <code>disk.frame</code> use:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(<span class="no">flights.df</span>, <span class="st">"path"</span>)</pre></body></html></div>
<p>You can also specify a location to output the <code>disk.frame</code> to using <code>outdir</code></p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">flights.df</span> <span class="kw">=</span> <span class="fu"><a href="../reference/as.disk.frame.html">as.disk.frame</a></span>(<span class="kw pkg">nycflights13</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/nycflights13/man/flights.html">flights</a></span>, <span class="kw">outdir</span> <span class="kw">=</span> <span class="st">"some/path.df"</span>)</pre></body></html></div>
<p>it is recommended that you use <code>.df</code> as the extension for a <code>disk.frame</code>, however this is not an enforced requirement.</p>
<p>However, one of the reasons for <code>disk.frame</code> to exist is to handle larger-than-RAM files, hence <code>as.disk.frame</code> is not all that useful because it can only convert data that can fit into RAM. <code>disk.frame</code> comes with a couple more ways to create <code>disk.frame</code>.</p>
</div>
<div id="creating-disk-frame-from-csvs" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-disk-frame-from-csvs" class="anchor"></a>Creating <code>disk.frame</code> from CSVs</h2>
<p>The function <code>csv_to_disk.frame</code> can convert CSV files to <code>disk.frame</code>. The most basic usage is</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">some.df</span> <span class="kw">=</span> <span class="fu"><a href="../reference/csv_to_disk.frame.html">csv_to_disk.frame</a></span>(<span class="st">"some/path.csv"</span>, <span class="kw">outdir</span> <span class="kw">=</span> <span class="st">"some.df"</span>)</pre></body></html></div>
<p>this will convert the CSV file <code>"some/path.csv"</code> to a <code>disk.frame</code>.</p>
</div>
<div id="multiple-csv-files" class="section level2">
<h2 class="hasAnchor">
<a href="#multiple-csv-files" class="anchor"></a>Multiple CSV files</h2>
<p>However, sometimes we have multiple CSV files that you want to read in and row-bind into one large <code>disk.frame</code>. You can do so by supplying a vector of file paths e.g. from the result of <code>list.files</code></p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">some.df</span> <span class="kw">=</span> <span class="fu"><a href="../reference/csv_to_disk.frame.html">csv_to_disk.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"some/path/file1.csv"</span>, <span class="st">"some/path/file2.csv"</span>))

<span class="co"># or</span>
<span class="no">some.df</span> <span class="kw">=</span> <span class="fu"><a href="../reference/csv_to_disk.frame.html">csv_to_disk.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="st">"some/path"</span>))</pre></body></html></div>
</div>
<div id="ingesting-csv-files-chunk-wise" class="section level2">
<h2 class="hasAnchor">
<a href="#ingesting-csv-files-chunk-wise" class="anchor"></a>Ingesting CSV files chunk-wise</h2>
<p>The <code><a href="../reference/csv_to_disk.frame.html">csv_to_disk.frame(path, ...)</a></code> function reads the file located at <code>path</code> in full into RAM but sometimes the CSV file may be too large to read in one go, as that would require loading the whole file into RAM. In that case, you can read the files chunk-by-chunk by using the <code>in_chunk_size</code> argument which controls how many rows you read in per chunk</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># to read in 1 million (=1e6) rows per chunk</span>
<span class="fu"><a href="../reference/csv_to_disk.frame.html">csv_to_disk.frame</a></span>(<span class="no">path</span>, <span class="kw">in_chunk_size</span> <span class="kw">=</span> <span class="fl">1e6</span>)</pre></body></html></div>
<p>When <code>in_chunk_size</code> is specified, the input file is split into many smaller files using <code>bigreadr</code>’s split file functions. This is generally the fastest way to ingest large CSVs, as the split files can be processed in parallel using all CPU cores. But the disk space requirement is doubled because the split files are as large as the original file. If you run out of disk space, then you must clean R’s temporary folder at <code><a href="https://rdrr.io/r/base/tempfile.html">tempdir()</a></code> and choose another <code>chunk_reader</code> e.g. <code><a href="../reference/csv_to_disk.frame.html">csv_to_disk.frame(..., chunk_reader = "LaF")</a></code>.</p>
</div>
<div id="sharding" class="section level2">
<h2 class="hasAnchor">
<a href="#sharding" class="anchor"></a>Sharding</h2>
<p>One of the most important aspects of <code>disk.frame</code> is sharding. One can shard a <code>disk.frame</code> at read time by using the <code>shardby</code></p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="../reference/csv_to_disk.frame.html">csv_to_disk.frame</a></span>(<span class="no">path</span>, <span class="kw">shardby</span> <span class="kw">=</span> <span class="st">"id"</span>)</pre></body></html></div>
<p>In the above case, all rows with the same <code>id</code> values will end up in the same chunk.</p>
</div>
<div id="just-in-time-transformation" class="section level2">
<h2 class="hasAnchor">
<a href="#just-in-time-transformation" class="anchor"></a>Just-in-time transformation</h2>
<p>Sometimes, one may wish to perform some transformation on the CSV before writing out to disk. One can use the <code>inmapfn</code> argument to do that. The <code>inmapfn</code> name comes from INput MAPping FuNction. The general usage pattern is as follows:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="../reference/csv_to_disk.frame.html">csv_to_disk.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(), <span class="st">"df.csv"</span>), <span class="kw">inmapfn</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">chunk</span>) {
  <span class="fu">some_transformation</span>(<span class="no">chunk</span>)
})</pre></body></html></div>
<p>As a contrived example, suppose you wish to convert a string into date at read time:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">df</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">date_str</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"2019-01-02"</span>, <span class="st">"2019-01-02"</span>))

<span class="co"># write the data.frame </span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span>(<span class="no">df</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(), <span class="st">"df.csv"</span>))


<span class="co"># this would show that date_str is a string</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="fu">collect</span>(<span class="fu"><a href="../reference/csv_to_disk.frame.html">csv_to_disk.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(), <span class="st">"df.csv"</span>)))$<span class="no">date_str</span>)
<span class="co">## chr [1:2] "2019-01-02" "2019-01-02"</span>

<span class="co"># this would show that date_str is a string</span>
<span class="no">df</span> <span class="kw">=</span> <span class="fu"><a href="../reference/csv_to_disk.frame.html">csv_to_disk.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(), <span class="st">"df.csv"</span>), <span class="kw">inmapfn</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">chunk</span>) {
  <span class="co"># convert to date_str to date format and store as "date"</span>
  <span class="no">chunk</span>[, <span class="no">date</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="no">date_str</span>, <span class="st">"%Y-%m-%d"</span>)]
  <span class="no">chunk</span>[, <span class="no">date_str</span><span class="kw">:=</span><span class="kw">NULL</span>]
})

<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="fu">collect</span>(<span class="no">df</span>)$<span class="no">date</span>)
<span class="co">## Date[1:2], format: "2019-01-02" "2019-01-02"</span></pre></body></html></div>
</div>
<div id="reading-csvs-from-zip-files" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-csvs-from-zip-files" class="anchor"></a>Reading CSVs from zip files</h2>
<p>Often, CSV comes zipped in a zip files. You can use the <code>zip_to_disk.frame</code> to convert all CSVs within a zip file</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="../reference/zip_to_disk.frame.html">zip_to_disk.frame</a></span>(<span class="no">path_to_zip_file</span>)</pre></body></html></div>
<p>The arguments for <code>zip_to_disk.frame</code> are the same as <code>csv_to_disk.frame</code>’s.</p>
</div>
<div id="using-add_chunk" class="section level2">
<h2 class="hasAnchor">
<a href="#using-add_chunk" class="anchor"></a>Using <code>add_chunk</code>
</h2>
<p>What if the method of converting to a <code>disk.frame</code> isn’t implemented in <code>disk.frame</code> yet? One can use some lower level constructs provided by <code>disk.frame</code> to create <code>disk.frame</code>s. For example, the <code>add_chunk</code> function can be used to add more chunks to a <code>disk.frame</code>, e.g.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">a.df</span> <span class="kw">=</span> <span class="fu"><a href="../reference/disk.frame.html">disk.frame</a></span>() <span class="co"># create an empty disk.frame</span>
<span class="fu"><a href="../reference/add_chunk.html">add_chunk</a></span>(<span class="no">a.df</span>, <span class="no">cars</span>) <span class="co"># adds cars as chunk 1</span>
<span class="fu"><a href="../reference/add_chunk.html">add_chunk</a></span>(<span class="no">a.df</span>, <span class="no">cars</span>) <span class="co"># adds cars as chunk 2</span></pre></body></html></div>
<p>Another example of using <code>add_chunk</code> is via <code>readr</code>’s chunked read functions to create a delimited file reader</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">delimited_to_disk.frame</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">file</span>, <span class="no">outdir</span>, <span class="no">...</span>) {
  <span class="no">res.df</span> <span class="kw">=</span> <span class="fu"><a href="../reference/disk.frame.html">disk.frame</a></span>(<span class="no">outdir</span>, <span class="no">...</span>)
  <span class="kw pkg">readr</span><span class="kw ns">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim_chunked.html">read_delim_chunked</a></span>(<span class="no">file</span>, <span class="kw">callback</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">chunk</span>) {
    <span class="fu"><a href="../reference/add_chunk.html">add_chunk</a></span>(<span class="no">res.df</span>, <span class="no">chunk</span>)
  }, <span class="no">...</span>)

  <span class="no">res.df</span>
}

<span class="fu">delimited_to_disk.frame</span>(<span class="no">path</span>, <span class="kw">outdir</span> <span class="kw">=</span> <span class="st">"some.df"</span>)</pre></body></html></div>
<p>The above code uses <code>readr</code>’s <code>read_delim_chunked</code> function to read <code>file</code> and call <code>add_chunk</code>. The problem with this approach is that is it sequential in nature and hence is not able to take advantage of parallelism.</p>
</div>
<div id="exploiting-the-structure-of-a-disk-frame" class="section level2">
<h2 class="hasAnchor">
<a href="#exploiting-the-structure-of-a-disk-frame" class="anchor"></a>Exploiting the structure of a disk.frame</h2>
<p>Of course, a <code>disk.frame</code> is just a folder with many <code>fst</code> files named as <code>1.fst</code>, <code>2.fst</code> etc. So one can simply create these <code>fst</code> files and ensure they have the same variable names and put them in a folder.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Dai ZJ.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
